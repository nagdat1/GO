═══════════════════════════════════════════════════════════════════════════
🧠 نظام الذاكرة لتحديد الإشارات العكسية (REVERSE) تلقائياً
═══════════════════════════════════════════════════════════════════════════

✅ تم تنفيذ نظام ذاكرة ذكي في المشروع (main.py) لتحديد الإشارات العكسية تلقائياً

📌 كيف يعمل النظام:
────────────────────────────────────────────────────────────────────────────

1. عند فتح صفقة جديدة (BUY أو SELL):
   ✓ المشروع يحفظ في الذاكرة: الرمز + نوع الصفقة (BUY أو SELL)
   ✓ مثال: BTCUSDT → BUY

2. عند وصول إشارة جديدة (BUY أو SELL) للرمز نفسه:
   ✓ المشروع يتحقق من الذاكرة:
   
   📊 السيناريو 1: صفقة BUY مفتوحة + إشارة SELL جديدة
      → النظام يحدد تلقائياً: SELL_REVERSE
   
   📊 السيناريو 2: صفقة SELL مفتوحة + إشارة BUY جديدة
      → النظام يحدد تلقائياً: BUY_REVERSE
   
   📊 السيناريو 3: لا توجد صفقة مفتوحة + إشارة BUY/SELL
      → النظام يعاملها كإشارة عادية (BUY أو SELL)

3. عند إغلاق الصفقة (TP3 أو STOP_LOSS):
   ✓ المشروع يحذف الرمز من الذاكرة
   ✓ الصفقة التالية ستكون إشارة عادية وليست REVERSE

═══════════════════════════════════════════════════════════════════════════
📋 مثال عملي:
═══════════════════════════════════════════════════════════════════════════

الساعة 10:00 → إشارة BUY على BTCUSDT
   ✓ المشروع يحفظ: BTCUSDT = BUY
   ✓ يرسل رسالة: "🟢 BUY SIGNAL"

الساعة 11:30 → إشارة SELL على BTCUSDT (قبل الوصول لـ TP3 أو SL)
   ✓ المشروع يتحقق من الذاكرة: BTCUSDT = BUY
   ✓ النظام يحدد تلقائياً: SELL_REVERSE
   ✓ يرسل رسالة: "🟠🔄🟠 SELL REVERSE SIGNAL"
   ✓ يحدث الذاكرة: BTCUSDT = SELL

الساعة 12:00 → وصول TP3 أو STOP_LOSS
   ✓ المشروع يحذف من الذاكرة: BTCUSDT (محذوف)
   ✓ يرسل رسالة: "🔴 TP3_HIT" أو "🔴 STOP_LOSS"

الساعة 13:00 → إشارة BUY جديدة على BTCUSDT
   ✓ المشروع يتحقق من الذاكرة: لا توجد صفقة (تم الحذف)
   ✓ النظام يعاملها كإشارة عادية: BUY
   ✓ يرسل رسالة: "🟢 BUY SIGNAL"
   ✓ يحفظ في الذاكرة: BTCUSDT = BUY

═══════════════════════════════════════════════════════════════════════════
✅ المميزات:
═══════════════════════════════════════════════════════════════════════════

1. ✅ لا حاجة لـ SIGNAL_CODE من المؤشر
   - حتى لو لم يرسل المؤشر SIGNAL_CODE بشكل صحيح
   - النظام يحدد REVERSE تلقائياً من الذاكرة

2. ✅ يعمل مع جميع أنواع التنبيهات
   - التنبيهات المنفصلة (8 تنبيهات)
   - التنبيه المركزي (تنبيه واحد)
   - أي تنسيق JSON أو نصي

3. ✅ دقة عالية
   - يتبع الصفقات حسب الرمز (symbol)
   - يحدد REVERSE فقط عندما تكون هناك صفقة مفتوحة
   - يحذف الصفقة من الذاكرة عند TP3 أو STOP_LOSS

4. ✅ آمن ومتزامن
   - يستخدم threading.Lock() لمنع التعارض
   - يعمل بشكل صحيح حتى مع طلبات متعددة في نفس الوقت

═══════════════════════════════════════════════════════════════════════════
🔧 الكود المضافة:
═══════════════════════════════════════════════════════════════════════════

في main.py:

1. قاموس open_positions: {symbol: signal_type}
   - يخزن الصفقات المفتوحة لكل رمز

2. دالة get_open_position(symbol):
   - ترجع نوع الصفقة المفتوحة (BUY/SELL) أو None

3. دالة set_open_position(symbol, signal_type):
   - تحفظ صفقة جديدة في الذاكرة

4. دالة clear_open_position(symbol):
   - تحذف صفقة من الذاكرة عند الإغلاق

5. دالة detect_reverse_signal(symbol, incoming_signal):
   - تحدد إذا كانت الإشارة REVERSE أم لا
   - ترجع: BUY_REVERSE, SELL_REVERSE, أو الإشارة الأصلية

6. في webhook():
   - عند BUY/SELL: يستخدم detect_reverse_signal()
   - عند BUY/SELL/REVERSE: يحفظ في الذاكرة
   - عند TP3/STOP_LOSS: يحذف من الذاكرة

═══════════════════════════════════════════════════════════════════════════
📝 ملاحظات مهمة:
═══════════════════════════════════════════════════════════════════════════

1. ⚠️ يجب أن يكون symbol (الرمز) موجوداً في البيانات
   - بدون symbol، لن يعمل نظام الذاكرة
   - تأكد من أن المؤشر يرسل "symbol" في الرسالة

2. ⚠️ النظام يعتمد على TP3 أو STOP_LOSS لحذف الصفقة
   - إذا لم تصل TP3 أو STOP_LOSS، ستظل الصفقة في الذاكرة
   - قد يؤدي هذا إلى تحديد REVERSE بشكل خاطئ في المستقبل

3. ⚠️ في حالة إعادة تشغيل المشروع:
   - يتم حذف الذاكرة (open_positions)
   - الصفقات المفتوحة قبل إعادة التشغيل لن تكون معروفة
   - الإشارة الأولى بعد إعادة التشغيل ستكون عادية (ليست REVERSE)

4. ✅ الحل للمشكلة السابقة:
   - لا حاجة لـ SIGNAL_CODE من المؤشر
   - لا حاجة لاستبدال {{plot(...)}} بكلمات
   - النظام يحدد REVERSE تلقائياً من الذاكرة

═══════════════════════════════════════════════════════════════════════════
🎯 الخلاصة:
═══════════════════════════════════════════════════════════════════════════

✅ تم تنفيذ نظام ذاكرة ذكي في المشروع
✅ يحدد الإشارات العكسية (REVERSE) تلقائياً
✅ لا يعتمد على SIGNAL_CODE من المؤشر
✅ يعمل مع جميع أنواع التنبيهات
✅ دقة عالية وآمن

🎉 المشروع الآن قادر على تحديد REVERSE بشكل تلقائي بناءً على الذاكرة!

═══════════════════════════════════════════════════════════════════════════
